<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<script src="http://yun.wisonic.cn/wisonic/static/common/js/jquery.js" type="text/javascript"></script>
<script src="https://cdn1.lncld.net/static/js/av-min-1.2.1.js"></script>
<script>
	//初始化AV Cloud
	function load() {
		// 应用 ID，用来识别应用
		var APP_ID = '7alskbs23551u3ywl073apx0c9t2lgmu2eusplh4pvtpcscv';

		// 应用 Key，用来校验权限（Web 端可以配置安全域名来保护数据安全）
		var APP_KEY = 'h5ezxy1xlzx76vxdqc1vumgap7hezlvdzwuexu0j614ejb73';

		// 初始化
		AV.init({
			appId: APP_ID,
			appKey: APP_KEY
		});
	}
	function testLeanCloud(id) {

		var DoctorUser = AV.Object.extend('DoctorUser');
		var doctorObject = new DoctorUser();
		doctorObject.save({
			mobilePhoneNumber: '13888888888',		//手机号
			mobilePhoneVerified: false,				//手机号已验证
			username: "Doctor Test",				//医生姓名
			hospital: "Shenzhen Test Hospital",		//医院
			department: "Ultrasound department"		//科室
		}).then(function () {
			window.location.href="success.html";
		}).catch(function (err) {
			alert('发送失败:' + err);
			window.location.href="failed.html";
		});

	}
	//检查手机号合法性
	function checkMobile(s_mobile){
		if(!(/^1[3|4|5|8][0-9]\d{4,8}$/.test(s_mobile))){
			return false;
		}
		return true;
	}
	//获取手机短信验证码
	function sendSmsVerifyCode(id) {
		var textMobilePhoneNumber = $("#textMobilePhoneNumber").val();
		if(checkMobile(textMobilePhoneNumber)) {
			console.log("textMobilePhoneNumber=" + textMobilePhoneNumber);
			//IMPORTANT: 需打开“应用选项”->“启用通用的短信验证码服务“
			AV.Cloud.requestSmsCode(textMobilePhoneNumber).then(function (success) {
				alert("AV.Cloud.requestSmsCode success, continue enter SmsVerifyCode");
			}, function (error) {
				alert("AV.Cloud.requestSmsCode error:" + error);
			});
		} else {
			console.log("不是完整的11位手机号或者正确的手机号前七位");
		}
	}
	//提交手机号与短信验证码
	function submitMobilePhoneNumber(id) {
		var textMobilePhoneNumber = $("#textMobilePhoneNumber").val();
		var textSmsVerifyCode = $("#textSmsVerifyCode").val();
		console.log("textMobilePhoneNumber=" + textMobilePhoneNumber);
		console.log("textSmsVerifyCode=" + textSmsVerifyCode);
		AV.User.signUpOrlogInWithMobilePhone(textMobilePhoneNumber, textSmsVerifyCode).then(function (success) {
			alert("AV.Cloud.signUpOrlogInWithMobilePhone success, continue enter DetailInfo");
		}, function (error) {
			alert("AV.Cloud.signUpOrlogInWithMobilePhone error");
		});
	}
	//提交详细用户信息
	function submitDetailInfo(id) {
		var textDoctorName = $("#textDoctorName").val();
		var textDoctorHospital = $("#textDoctorHospital").val();
		var textDoctorDept = $("#textDoctorDept").val();
		console.log("textDoctorName=" + textDoctorName);
		console.log("textDoctorHospital=" + textDoctorHospital);
		console.log("textDoctorDept=" + textDoctorDept);
		var currentUser = AV.User.current();
		if(currentUser) {
			currentUser.set('doctorName', textDoctorName);
			currentUser.set('doctorHospital', textDoctorHospital);
			currentUser.set('doctorDept', textDoctorDept);
			currentUser.save().then(function(){
				console.log("Save DetailInfo success!");
			}).catch(function(err) {
				alert('error:' + err);
			});
		} else {
			alert("AV.User.current failed!")
		}
	} 
</script>

</head>
<body onload="load()">
    <h1 onclick="testLeanCloud(this)">测试LeanCloud</h1>
	
	<div>
		手机号：<br/>
		<input type="text" id="textMobilePhoneNumber"/>
		<br/>
		验证码：<br/>
		<input type="text" id="textSmsVerifyCode"/>
		<br/><br/>
		<button type="button" onclick="sendSmsVerifyCode(this)">发送验证码</button>
		<button type="button" onclick="submitMobilePhoneNumber(this)">提交注册</button>
	</div>

	<br/><br/>
	<div>
		姓名：<br/>
		<input type="text" id="textDoctorName"/> <br/>
		医院：<br/>
		<input type="text" id="textDoctorHospital"/> <br/>
		科室：<br/>
		<input type="text" id="textDoctorDept"/> <br/>
		<br/><br/>
		<button type="button" onclick="submitDetailInfo(this)">提交</button>
	</div>
	
</body>
</html>
